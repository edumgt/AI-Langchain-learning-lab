<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ArtBiz LangChain E2E</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-10">
    <header class="flex flex-col gap-2 mb-8">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-slate-800/80 grid place-items-center shadow">
          <span class="text-lg">ğŸ­</span>
        </div>
        <div>
          <h1 class="text-2xl font-semibold tracking-tight">ArtBiz LangChain E2E</h1>
          <p class="text-slate-400 text-sm">í•™ìŠµìš© ë¯¸ë‹ˆ í´ë¼ì´ì–¸íŠ¸ â€” <span class="font-mono">/chat</span>, <span class="font-mono">/rag/self-query</span>, <span class="font-mono">/artbiz/proposal</span>, <span class="font-mono">/docs/upload</span></p>
        </div>
      </div>

      <div class="flex flex-wrap gap-2 text-xs text-slate-400">
        <span class="px-2 py-1 rounded-full bg-slate-800/60 border border-slate-700/60">API: same-origin</span>
        <span class="px-2 py-1 rounded-full bg-slate-800/60 border border-slate-700/60">Ollama: docker network</span>
        <span class="px-2 py-1 rounded-full bg-slate-800/60 border border-slate-700/60">Tailwind: CDN</span>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Left: Controls -->
      <section class="rounded-2xl bg-slate-900/60 border border-slate-800 shadow p-5">
        <h2 class="text-lg font-semibold mb-4">ìš”ì²­</h2>

        <label class="block text-sm text-slate-300 mb-2">ì§ˆë¬¸</label>
        <textarea id="q" class="w-full min-h-[120px] rounded-xl bg-slate-950/60 border border-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-600 px-3 py-2 text-sm"
          placeholder="ì˜ˆ) ì˜ˆì‚° 3ì²œë§Œì›ìœ¼ë¡œ 2ì£¼ ê´€ê°ê°œë°œ ìº í˜ì¸ ì‹¤í–‰ ê³„íš">ì˜ˆì‚° 3ì²œë§Œì›ìœ¼ë¡œ 2ì£¼ ê´€ê°ê°œë°œ ìº í˜ì¸ ì‹¤í–‰ ê³„íš</textarea>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
          <div class="flex flex-col gap-1">
            <label class="text-sm text-slate-300">mode</label>
            <select id="mode" class="rounded-xl bg-slate-950/60 border border-slate-800 px-3 py-2 text-sm">
              <option value="rag" selected>rag</option>
              <option value="chat">chat</option>
              <option value="plan">plan</option>
            </select>
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm text-slate-300">top_k</label>
            <input id="topk" type="number" value="4" min="1" max="20"
              class="rounded-xl bg-slate-950/60 border border-slate-800 px-3 py-2 text-sm"/>
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm text-slate-300">auto_approve</label>
            <select id="autoApprove" class="rounded-xl bg-slate-950/60 border border-slate-800 px-3 py-2 text-sm">
              <option value="true" selected>true</option>
              <option value="false">false</option>
            </select>
          </div>
        </div>

        <div class="flex flex-wrap gap-2 mt-4">
          <button onclick="doChat()" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 text-sm font-medium shadow">/chat</button>
          <button onclick="doSelfQuery()" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 active:bg-slate-900 text-sm font-medium border border-slate-700 shadow">/rag/self-query</button>
          <button onclick="doProposal()" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 active:bg-emerald-700 text-sm font-medium shadow">/artbiz/proposal</button>
        </div>

        <hr class="border-slate-800 my-6"/>

        <h3 class="text-md font-semibold mb-3">Docs Upload</h3>
        <p class="text-xs text-slate-400 mb-3">
          íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ <span class="font-mono">/docs/upload</span>ë¡œ ì „ì†¡ë©ë‹ˆë‹¤. (í•„ë“œ: <span class="font-mono">files</span>, multiple ì§€ì›)
        </p>
        <div class="flex flex-col md:flex-row gap-2 md:items-center">
          <input id="files" type="file" multiple
            class="block w-full text-sm text-slate-300 file:mr-3 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-medium file:bg-slate-800 file:text-slate-100 hover:file:bg-slate-700"/>
          <button onclick="doUpload()" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 active:bg-slate-900 text-sm font-medium border border-slate-700 shadow">Upload</button>
        </div>
        <pre id="upload_out" class="mt-3 text-xs rounded-xl bg-slate-950/60 border border-slate-800 p-3 overflow-auto max-h-52"></pre>

        <hr class="border-slate-800 my-6"/>

        <h3 class="text-md font-semibold mb-3">Proposal Options</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="flex flex-col gap-1">
            <label class="text-sm text-slate-300">sponsor_name</label>
            <input id="sponsor" value="ACME Corp"
              class="rounded-xl bg-slate-950/60 border border-slate-800 px-3 py-2 text-sm"/>
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm text-slate-300">campaign_title</label>
            <input id="campaign" value="Spring Festival" 
              class="rounded-xl bg-slate-950/60 border border-slate-800 px-3 py-2 text-sm"/>
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm text-slate-300">budget_total_krw</label>
            <input id="budget" type="number" value="30000000" min="1"
              class="rounded-xl bg-slate-950/60 border border-slate-800 px-3 py-2 text-sm"/>
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm text-slate-300">weeks</label>
            <input id="weeks" type="number" value="2" min="1" max="12"
              class="rounded-xl bg-slate-950/60 border border-slate-800 px-3 py-2 text-sm"/>
          </div>
        </div>

        <div class="flex flex-wrap gap-2 mt-4">
          <label class="inline-flex items-center gap-2 text-sm text-slate-300">
            <input id="save" type="checkbox" checked class="rounded border-slate-700 bg-slate-900"/>
            save
          </label>
          <select id="format" class="rounded-xl bg-slate-950/60 border border-slate-800 px-3 py-2 text-sm">
            <option value="md" selected>md</option>
            <option value="pdf">pdf</option>
            <option value="both">both</option>
          </select>
          <select id="orgType" class="rounded-xl bg-slate-950/60 border border-slate-800 px-3 py-2 text-sm">
            <option value="general" selected>general</option>
            <option value="festival">festival</option>
            <option value="museum">museum</option>
            <option value="theatre">theatre</option>
            <option value="foundation">foundation</option>
            <option value="gallery">gallery</option>
          </select>
        </div>
      </section>

      <!-- Right: Output -->
      <section class="rounded-2xl bg-slate-900/60 border border-slate-800 shadow p-5">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-lg font-semibold">Response</h2>
          <div class="flex items-center gap-2">
            <span id="statusDot" class="h-2.5 w-2.5 rounded-full bg-slate-500"></span>
            <span id="statusText" class="text-xs text-slate-400">idle</span>
          </div>
        </div>

        <div class="mt-4">
          <pre id="out" class="text-xs rounded-xl bg-slate-950/60 border border-slate-800 p-4 overflow-auto min-h-[520px]"></pre>
        </div>

        <div class="mt-4 text-xs text-slate-400 leading-relaxed">
          <p class="mb-1">íŒ</p>
          <ul class="list-disc pl-5 space-y-1">
            <li><span class="font-mono">/artbiz/proposal</span> 500ì´ë©´ ë³´í†µ <span class="font-mono">nomic-embed-text</span> ì„ë² ë”© ëª¨ë¸ ë¯¸ì„¤ì¹˜ ë˜ëŠ” LLM íƒ€ì„ì•„ì›ƒì…ë‹ˆë‹¤.</li>
            <li>Ollama ëª¨ë¸: <span class="font-mono">ollama pull llama3.1:8b</span>, <span class="font-mono">ollama pull nomic-embed-text</span></li>
          </ul>
        </div>
      </section>
    </main>
  </div>

<script>
  function setStatus(state, msg){
    const dot = document.getElementById('statusDot');
    const text = document.getElementById('statusText');
    text.textContent = msg || state;
    dot.className = 'h-2.5 w-2.5 rounded-full ' + (
      state === 'ok' ? 'bg-emerald-500' :
      state === 'err' ? 'bg-rose-500' :
      state === 'work' ? 'bg-amber-400' : 'bg-slate-500'
    );
  }

  async function apiPostJson(path, body){
    setStatus('work', 'requestingâ€¦');
    const res = await fetch(path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    let data = null;
    try { data = await res.json(); } catch(e){ data = { raw: await res.text() }; }
    if(!res.ok){
      setStatus('err', 'error');
      throw { status: res.status, data };
    }
    setStatus('ok', 'ok');
    return data;
  }

  function show(obj){
    document.getElementById('out').textContent = JSON.stringify(obj, null, 2);
  }
  function showUpload(obj){
    document.getElementById('upload_out').textContent = JSON.stringify(obj, null, 2);
  }

  async function doChat(){
    const q = document.getElementById('q').value;
    const mode = document.getElementById('mode').value;
    const topk = parseInt(document.getElementById('topk').value || '0', 10);
    const autoApprove = document.getElementById('autoApprove').value === 'true';
    try{
      const data = await apiPostJson('/chat', { q, mode, top_k: topk || null, auto_approve: autoApprove });
      show(data);
    }catch(e){
      show(e);
    }
  }

  async function doSelfQuery(){
    const q = document.getElementById('q').value;
    const topk = parseInt(document.getElementById('topk').value || '4', 10);
    try{
      const data = await apiPostJson('/rag/self-query', { q, top_k: topk || 4 });
      show(data);
    }catch(e){
      show(e);
    }
  }

  async function doProposal(){
    const sponsor = document.getElementById('sponsor').value;
    const campaign = document.getElementById('campaign').value;
    const budget = parseInt(document.getElementById('budget').value || '0', 10);
    const weeks = parseInt(document.getElementById('weeks').value || '2', 10);
    const save = document.getElementById('save').checked;
    const format = document.getElementById('format').value;
    const org_type = document.getElementById('orgType').value;
    const autoApprove = document.getElementById('autoApprove').value === 'true';

    try{
      const data = await apiPostJson('/artbiz/proposal', {
        sponsor_name: sponsor,
        campaign_title: campaign,
        budget_total_krw: budget,
        weeks,
        save,
        format,
        org_type,
        auto_approve: autoApprove
      });
      show(data);
    }catch(e){
      show(e);
    }
  }

  async function doUpload(){
    const input = document.getElementById('files');
    const files = input.files;
    if(!files || files.length === 0){
      showUpload({ok:false, detail:'íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.'});
      return;
    }
    setStatus('work', 'uploadingâ€¦');
    const fd = new FormData();
    for(const f of files){ fd.append('files', f); }  // multiple
    const res = await fetch('/docs/upload', { method:'POST', body: fd });
    let data = null;
    try { data = await res.json(); } catch(e){ data = { raw: await res.text() }; }
    if(!res.ok){
      setStatus('err', 'upload error');
      showUpload({status:res.status, data});
      return;
    }
    setStatus('ok', 'uploaded');
    showUpload(data);
  }
</script>
</body>
</html>
